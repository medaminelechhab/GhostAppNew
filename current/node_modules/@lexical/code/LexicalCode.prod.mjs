/**
 * Copyright (c) Meta Platforms, Inc. and affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */
import{addClassNamesToElement as e,isHTMLElement as t,removeClassNamesFromElement as n,mergeRegister as r}from"@lexical/utils";import{ElementNode as o,$applyNodeReplacement as i,$createParagraphNode as s,$isTextNode as l,$isTabNode as c,$createTabNode as u,$createLineBreakNode as a,TextNode as g,$isLineBreakNode as f,$getNodeByKey as p,KEY_TAB_COMMAND as h,COMMAND_PRIORITY_LOW as d,INSERT_TAB_COMMAND as m,$getSelection as x,$insertNodes as N,INDENT_CONTENT_COMMAND as y,OUTDENT_CONTENT_COMMAND as C,KEY_ARROW_UP_COMMAND as v,KEY_ARROW_DOWN_COMMAND as T,MOVE_TO_END as _,MOVE_TO_START as b,$createTextNode as j,$isRangeSelection as S}from"lexical";import*as k from"prismjs";import*as w from"prismjs/components/prism-clike.js";import*as L from"prismjs/components/prism-javascript.js";import*as P from"prismjs/components/prism-markup.js";import*as E from"prismjs/components/prism-markdown.js";import*as O from"prismjs/components/prism-c.js";import*as A from"prismjs/components/prism-css.js";import*as D from"prismjs/components/prism-objectivec.js";import*as M from"prismjs/components/prism-sql.js";import*as B from"prismjs/components/prism-python.js";import*as z from"prismjs/components/prism-rust.js";import*as H from"prismjs/components/prism-swift.js";import*as F from"prismjs/components/prism-typescript.js";import*as J from"prismjs/components/prism-java.js";import*as K from"prismjs/components/prism-cpp.js";const R=e=>null!=e&&k.languages.hasOwnProperty(e)?e:void 0;function I(e,n){for(const r of e.childNodes){if(t(r)&&r.tagName===n)return!0;I(r,n)}return!1}const q="data-highlight-language";class U extends o{static getType(){return"code"}static clone(e){return new U(e.__language,e.__key)}constructor(e,t){super(t),this.__language=R(e)}createDOM(t){const n=document.createElement("code");e(n,t.theme.code),n.setAttribute("spellcheck","false");const r=this.getLanguage();return r&&n.setAttribute(q,r),n}updateDOM(e,t,n){const r=this.__language,o=e.__language;return r?r!==o&&t.setAttribute(q,r):o&&t.removeAttribute(q),!1}exportDOM(t){const n=document.createElement("pre");e(n,t._config.theme.code),n.setAttribute("spellcheck","false");const r=this.getLanguage();return r&&n.setAttribute(q,r),{element:n}}static importDOM(){return{code:e=>null!=e.textContent&&(/\r?\n/.test(e.textContent)||I(e,"BR"))?{conversion:X,priority:1}:null,div:e=>({conversion:G,priority:1}),pre:e=>({conversion:X,priority:0}),table:e=>ee(e)?{conversion:V,priority:3}:null,td:e=>{const t=e,n=t.closest("table");return t.classList.contains("js-file-line")?{conversion:Z,priority:3}:n&&ee(n)?{conversion:Y,priority:3}:null},tr:e=>{const t=e.closest("table");return t&&ee(t)?{conversion:Y,priority:3}:null}}}static importJSON(e){const t=W(e.language);return t.setFormat(e.format),t.setIndent(e.indent),t.setDirection(e.direction),t}exportJSON(){return{...super.exportJSON(),language:this.getLanguage(),type:"code",version:1}}insertNewAfter(e,t=!0){const n=this.getChildren(),r=n.length;if(r>=2&&"\n"===n[r-1].getTextContent()&&"\n"===n[r-2].getTextContent()&&e.isCollapsed()&&e.anchor.key===this.__key&&e.anchor.offset===r){n[r-1].remove(),n[r-2].remove();const e=s();return this.insertAfter(e,t),e}const{anchor:o,focus:i}=e,g=(o.isBefore(i)?o:i).getNode();if(l(g)){let e=fe(g);const t=[];for(;;)if(c(e))t.push(u()),e=e.getNextSibling();else{if(!ge(e))break;{let n=0;const r=e.getTextContent(),o=e.getTextContentSize();for(;n<o&&" "===r[n];)n++;if(0!==n&&t.push(ae(" ".repeat(n))),n!==o)break;e=e.getNextSibling()}}const n=g.splitText(o.offset)[0],r=0===o.offset?0:1,i=n.getIndexWithinParent()+r,s=g.getParentOrThrow(),l=[a(),...t];s.splice(i,0,l);const f=t[t.length-1];f?f.select():0===o.offset?n.selectPrevious():n.getNextSibling().selectNext(0,0)}if(Q(g)){const{offset:t}=e.anchor;g.splice(t,0,[a()]),g.select(t+1,t+1)}return null}canIndent(){return!1}collapseAtStart(){const e=s();return this.getChildren().forEach((t=>e.append(t))),this.replace(e),!0}setLanguage(e){this.getWritable().__language=R(e)}getLanguage(){return this.getLatest().__language}}function W(e){return i(new U(e))}function Q(e){return e instanceof U}function X(e){let n;return t(e)&&(n=e.getAttribute(q)),{node:W(n)}}function G(e){const t=e,n=$(t);return n||function(e){let t=e.parentElement;for(;null!==t;){if($(t))return!0;t=t.parentElement}return!1}(t)?{after:t=>{const n=e.parentNode;return null!=n&&e!==n.lastChild&&t.push(a()),t},node:n?W():null}:{node:null}}function V(){return{node:W()}}function Y(){return{node:null}}function Z(e){const t=e;return{after:e=>(t.parentNode&&t.parentNode.nextSibling&&e.push(a()),e),node:null}}function $(e){return null!==e.style.fontFamily.match("monospace")}function ee(e){return e.classList.contains("js-file-line-container")}const te="javascript",ne={c:"C",clike:"C-like",cpp:"C++",css:"CSS",html:"HTML",java:"Java",js:"JavaScript",markdown:"Markdown",objc:"Objective-C",plain:"Plain Text",py:"Python",rust:"Rust",sql:"SQL",swift:"Swift",typescript:"TypeScript",xml:"XML"},re={cpp:"cpp",java:"java",javascript:"js",md:"markdown",plaintext:"plain",python:"py",text:"plain",ts:"typescript"};function oe(e){return re[e]||e}function ie(e){const t=oe(e);return ne[t]||t}const se=()=>te,le=()=>Object.keys(k.languages).filter((e=>"function"!=typeof k.languages[e])).sort();class ce extends g{constructor(e,t,n){super(e,n),this.__highlightType=t}static getType(){return"code-highlight"}static clone(e){return new ce(e.__text,e.__highlightType||void 0,e.__key)}getHighlightType(){return this.getLatest().__highlightType}canHaveFormat(){return!1}createDOM(t){const n=super.createDOM(t),r=ue(t.theme,this.__highlightType);return e(n,r),n}updateDOM(t,r,o){const i=super.updateDOM(t,r,o),s=ue(o.theme,t.__highlightType),l=ue(o.theme,this.__highlightType);return s!==l&&(s&&n(r,s),l&&e(r,l)),i}static importJSON(e){const t=ae(e.text,e.highlightType);return t.setFormat(e.format),t.setDetail(e.detail),t.setMode(e.mode),t.setStyle(e.style),t}exportJSON(){return{...super.exportJSON(),highlightType:this.getHighlightType(),type:"code-highlight",version:1}}setFormat(e){return this}isParentRequired(){return!0}createParentElementNode(){return W()}}function ue(e,t){return t&&e&&e.codeHighlight&&e.codeHighlight[t]}function ae(e,t){return i(new ce(e,t))}function ge(e){return e instanceof ce}function fe(e){let t=e,n=e;for(;ge(n)||c(n);)t=n,n=n.getPreviousSibling();return t}function pe(e){let t=e,n=e;for(;ge(n)||c(n);)t=n,n=n.getNextSibling();return t}const he={defaultLanguage:te,tokenize(e,t){return k.tokenize(e,k.languages[t||""]||k.languages[this.defaultLanguage])}};function de(e,t){let n=null,r=null,o=e,i=t,s=e.getTextContent();for(;;){if(0===i){if(o=o.getPreviousSibling(),null===o)break;if(!(ge(o)||c(o)||f(o)))throw Error("Expected a valid Code Node: CodeHighlightNode, TabNode, LineBreakNode");if(f(o)){n={node:o,offset:1};break}i=Math.max(0,o.getTextContentSize()-1),s=o.getTextContent()}else i--;const e=s[i];ge(o)&&" "!==e&&(r={node:o,offset:i})}if(null!==r)return r;let l=null;if(t<e.getTextContentSize())ge(e)&&(l=e.getTextContent()[t]);else{const t=e.getNextSibling();ge(t)&&(l=t.getTextContent()[0])}if(null!==l&&" "!==l)return n;{const r=function(e,t){let n=e,r=t,o=e.getTextContent(),i=e.getTextContentSize();for(;;){if(!ge(n)||r===i){if(n=n.getNextSibling(),null===n||f(n))return null;ge(n)&&(r=0,o=n.getTextContent(),i=n.getTextContentSize())}if(ge(n)){if(" "!==o[r])return{node:n,offset:r};r++}}}(e,t);return null!==r?r:n}}function me(e){const t=pe(e);if(f(t))throw Error("Unexpected lineBreakNode in getEndOfCodeInLine");return t}function xe(e,t,n){const r=e.getParent();Q(r)?Ce(r,t,n):ge(e)&&e.replace(j(e.__text))}function Ne(e,t){const n=t.getElementByKey(e.getKey());if(null===n)return;const r=e.getChildren(),o=r.length;if(o===n.__cachedChildrenLength)return;n.__cachedChildrenLength=o;let i="1",s=1;for(let e=0;e<o;e++)f(r[e])&&(i+="\n"+ ++s);n.setAttribute("data-gutter",i)}const ye=new Set;function Ce(e,t,n){const r=e.getKey();ye.has(r)||(ye.add(r),void 0===e.getLanguage()&&e.setLanguage(n.defaultLanguage),t.update((()=>{!function(e,t){const n=p(e);if(!Q(n)||!n.isAttached())return;const r=x();if(!S(r))return void t();const o=r.anchor,i=o.offset,s="element"===o.type&&f(n.getChildAtIndex(o.offset-1));let c=0;if(!s){const e=o.getNode();c=i+e.getPreviousSiblings().reduce(((e,t)=>e+t.getTextContentSize()),0)}if(!t())return;if(s)return void o.getNode().select(i,i);n.getChildren().some((e=>{const t=l(e);if(t||f(e)){const n=e.getTextContentSize();if(t&&n>=c)return e.select(c,c),!0;c-=n}return!1}))}(r,(()=>{const t=p(r);if(!Q(t)||!t.isAttached())return!1;const o=t.getTextContent(),i=ve(n.tokenize(o,t.getLanguage()||n.defaultLanguage)),s=function(e,t){let n=0;for(;n<e.length&&Te(e[n],t[n]);)n++;const r=e.length,o=t.length,i=Math.min(r,o)-n;let s=0;for(;s<i;)if(s++,!Te(e[r-s],t[o-s])){s--;break}const l=n,c=r-s,u=t.slice(n,o-s);return{from:l,nodesForReplacement:u,to:c}}(t.getChildren(),i),{from:l,to:c,nodesForReplacement:u}=s;return!(l===c&&!u.length)&&(e.splice(l,c-l,u),!0)}))}),{onUpdate:()=>{ye.delete(r)},skipTransforms:!0}))}function ve(e,t){const n=[];for(const r of e)if("string"==typeof r){const e=r.split(/(\n|\t)/),o=e.length;for(let r=0;r<o;r++){const o=e[r];"\n"===o||"\r\n"===o?n.push(a()):"\t"===o?n.push(u()):o.length>0&&n.push(ae(o,t))}}else{const{content:e}=r;"string"==typeof e?n.push(...ve([e],r.type)):Array.isArray(e)&&n.push(...ve(e,r.type))}return n}function Te(e,t){return ge(e)&&ge(t)&&e.__text===t.__text&&e.__highlightType===t.__highlightType||c(e)&&c(t)||f(e)&&f(t)}function _e(e){if(!S(e))return!1;const t=e.anchor.getNode(),n=e.focus.getNode();if(t.is(n)&&Q(t))return!0;const r=t.getParent();return Q(r)&&r.is(n.getParent())}function be(e){const t=e.getNodes(),n=[[]];if(1===t.length&&Q(t[0]))return n;let r=n[0];for(let e=0;e<t.length;e++){const o=t[e];if(!(ge(o)||c(o)||f(o)))throw Error("Expected selection to be inside CodeBlock and consisting of CodeHighlightNode, TabNode and LineBreakNode");f(o)?0!==e&&r.length>0&&(r=[],n.push(r)):r.push(o)}return n}function je(e){const t=x();if(!S(t)||!_e(t))return!1;const n=be(t),r=n.length;if(n.length>1){for(let t=0;t<r;t++){const r=n[t];if(r.length>0){let n=r[0];0===t&&(n=fe(n)),null!==n&&(e===y?n.insertBefore(u()):c(n)&&n.remove())}}return!0}const o=t.getNodes()[0];if(!(Q(o)||ge(o)||c(o)||f(o)))throw Error("Expected selection firstNode to be CodeHighlightNode or CodeTabNode");if(Q(o))return e===y&&t.insertNodes([u()]),!0;const i=fe(o);if(null===i)throw Error("Expected getFirstCodeNodeOfLine to return a valid Code Node");return e===y?f(i)?i.insertAfter(u()):i.insertBefore(u()):c(i)&&i.remove(),!0}function Se(e,t){const n=x();if(!S(n))return!1;const{anchor:r,focus:o}=n,i=r.offset,s=o.offset,l=r.getNode(),u=o.getNode(),a=e===v;if(!_e(n)||!ge(l)&&!c(l)||!ge(u)&&!c(u))return!1;if(!t.altKey){if(n.isCollapsed()){const e=l.getParentOrThrow();if(a&&0===i&&null===l.getPreviousSibling()){if(null===e.getPreviousSibling())return e.selectPrevious(),t.preventDefault(),!0}else if(!a&&i===l.getTextContentSize()&&null===l.getNextSibling()){if(null===e.getNextSibling())return e.selectNext(),t.preventDefault(),!0}}return!1}let g,p;if(l.isBefore(u)?(g=fe(l),p=pe(u)):(g=fe(u),p=pe(l)),null==g||null==p)return!1;const h=g.getNodesBetween(p);for(let e=0;e<h.length;e++){const t=h[e];if(!ge(t)&&!c(t)&&!f(t))return!1}t.preventDefault(),t.stopPropagation();const d=a?g.getPreviousSibling():p.getNextSibling();if(!f(d))return!0;const m=a?d.getPreviousSibling():d.getNextSibling();if(null==m)return!0;const N=ge(m)||c(m)||f(m)?a?fe(m):pe(m):null;let y=null!=N?N:m;return d.remove(),h.forEach((e=>e.remove())),e===v?(h.forEach((e=>y.insertBefore(e))),y.insertBefore(d)):(y.insertAfter(d),y=d,h.forEach((e=>{y.insertAfter(e),y=e}))),n.setTextNodeRange(l,i,u,s),!0}function ke(e,t){const n=x();if(!S(n))return!1;const{anchor:r,focus:o}=n,i=r.getNode(),s=o.getNode(),l=e===b;if(!ge(i)&&!c(i)||!ge(s)&&!c(s))return!1;if(l){const e=de(s,o.offset);if(null!==e){const{node:t,offset:r}=e;f(t)?t.selectNext(0,0):n.setTextNodeRange(t,r,t,r)}else s.getParentOrThrow().selectStart()}else{me(s).select()}return t.preventDefault(),t.stopPropagation(),!0}function we(e,t){if(!e.hasNodes([U,ce]))throw new Error("CodeHighlightPlugin: CodeNode or CodeHighlightNode not registered on editor");return null==t&&(t=he),r(e.registerMutationListener(U,(t=>{e.update((()=>{for(const[n,r]of t)if("destroyed"!==r){const t=p(n);null!==t&&Ne(t,e)}}))})),e.registerNodeTransform(U,(n=>Ce(n,e,t))),e.registerNodeTransform(g,(n=>xe(n,e,t))),e.registerNodeTransform(ce,(n=>xe(n,e,t))),e.registerCommand(h,(t=>{const n=function(e){const t=x();if(!S(t)||!_e(t))return null;const n=e?C:y,r=e?C:m;if(be(t).length>1)return n;const o=t.getNodes()[0];if(!(Q(o)||ge(o)||c(o)||f(o)))throw Error("Expected selection firstNode to be CodeHighlightNode or TabNode");if(Q(o))return n;const i=fe(o),s=pe(o),l=t.anchor,u=t.focus;let a,g;return u.isBefore(l)?(a=u,g=l):(a=l,g=u),null!==i&&null!==s&&a.key===i.getKey()&&0===a.offset&&g.key===s.getKey()&&g.offset===s.getTextContentSize()?n:r}(t.shiftKey);return null!==n&&(t.preventDefault(),e.dispatchCommand(n,void 0),!0)}),d),e.registerCommand(m,(()=>!!_e(x())&&(N([u()]),!0)),d),e.registerCommand(y,(e=>je(y)),d),e.registerCommand(C,(e=>je(C)),d),e.registerCommand(v,(e=>Se(v,e)),d),e.registerCommand(T,(e=>Se(T,e)),d),e.registerCommand(_,(e=>ke(_,e)),d),e.registerCommand(b,(e=>ke(b,e)),d))}export{ae as $createCodeHighlightNode,W as $createCodeNode,ge as $isCodeHighlightNode,Q as $isCodeNode,ne as CODE_LANGUAGE_FRIENDLY_NAME_MAP,re as CODE_LANGUAGE_MAP,ce as CodeHighlightNode,U as CodeNode,te as DEFAULT_CODE_LANGUAGE,he as PrismTokenizer,le as getCodeLanguages,se as getDefaultCodeLanguage,me as getEndOfCodeInLine,fe as getFirstCodeNodeOfLine,ie as getLanguageFriendlyName,pe as getLastCodeNodeOfLine,de as getStartOfCodeInLine,oe as normalizeCodeLang,we as registerCodeHighlighting};
